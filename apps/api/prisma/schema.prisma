generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Currency {
  // Americas
  MXN  // Mexican Peso
  USD  // US Dollar
  CAD  // Canadian Dollar
  BRL  // Brazilian Real
  ARS  // Argentine Peso
  CLP  // Chilean Peso
  COP  // Colombian Peso
  PEN  // Peruvian Sol

  // Europe
  EUR  // Euro
  GBP  // British Pound
  CHF  // Swiss Franc
  SEK  // Swedish Krona
  NOK  // Norwegian Krone
  DKK  // Danish Krone
  PLN  // Polish Zloty

  // Asia Pacific
  CNY  // Chinese Yuan
  JPY  // Japanese Yen
  KRW  // South Korean Won
  INR  // Indian Rupee
  SGD  // Singapore Dollar
  HKD  // Hong Kong Dollar
  AUD  // Australian Dollar
  NZD  // New Zealand Dollar
  TWD  // Taiwan Dollar
  THB  // Thai Baht

  // Middle East & Africa
  AED  // UAE Dirham
  SAR  // Saudi Riyal
  ZAR  // South African Rand
  EGP  // Egyptian Pound
}

// ==================== CORE MODELS ====================

model Tenant {
  id                    String   @id @default(cuid())
  name                  String
  code                  String   @unique
  domain                String?  @unique
  defaultCurrency       Currency @default(MXN)
  supportedCurrencies   Currency[] @default([MXN, USD])
  defaultLocale         String   @default("es")
  supportedLocales      String[] @default(["es", "en"])
  features              Json     @default("{}")
  settings              Json     @default("{}")
  branding              Json     @default("{}")
  active                Boolean  @default(true)

  // Billing fields
  billingPlanId         String?
  stripeCustomerId      String?  @unique
  stripeSubscriptionId  String?  @unique

  // Janua multi-provider billing (Conekta for MX, Polar for international)
  januaCustomerId       String?  @unique
  billingProvider       String?  // 'conekta' | 'polar' | 'stripe'
  countryCode           String?  // ISO country code for billing routing
  taxId                 String?  // RFC for Mexican CFDI
  companyName           String?  // Legal company name for invoicing
  email                 String?  // Billing contact email

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  users          User[]
  materials      Material[]
  machines       Machine[]
  processOptions ProcessOption[]
  quotes         Quote[]
  auditLogs      AuditLog[]
  ndaAcceptances NDAAcceptance[]
  discountRules  DiscountRule[]
  shippingRates  ShippingRate[]
  pricingRules   PricingRule[]
  margins        Margin[]
  customers      Customer[]
  apiKeys        ApiKey[]
  billingPlan    BillingPlan? @relation(fields: [billingPlanId], references: [id])
  invoices       Invoice[]
  usageEvents    UsageEvent[]
  tenantSettings TenantSettings?

  @@index([code])
  @@index([domain])
  @@index([billingPlanId])
  @@index([stripeCustomerId])
}

model TenantSettings {
  id        String   @id @default(cuid())
  tenantId  String   @unique
  settings  Json     @default("{}")
  branding  Json     @default("{}")
  features  Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("tenant_settings")
}

model User {
  id              String    @id @default(cuid())
  tenantId        String
  email           String    @unique
  passwordHash    String?
  firstName       String?
  lastName        String?
  name            String?
  phone           String?
  role            String    @default("customer")
  roles           String[]  @default(["customer"])
  active          Boolean   @default(true)
  emailVerified   Boolean   @default(false)
  preferredLocale String    @default("es")
  lastLogin       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tenant               Tenant            @relation(fields: [tenantId], references: [id])
  quotes               Quote[]
  auditLogs            AuditLog[]
  ndaAcceptances       NDAAcceptance[]
  sessions             Session[]
  customer             Customer?
  orders               Order[]
  invoices             Invoice[]
  convertedSessions    GuestSession[]
  quoteConversions     QuoteConversion[]
  usageEvents          UsageEvent[]
  supportTickets       SupportTicket[]
  assignedTickets      SupportTicket[]      @relation("AssignedTickets")
  ticketMessages       SupportTicketMessage[]
  preferences          UserPreferences?

  @@index([tenantId])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Customer {
  id              String   @id @default(cuid())
  tenantId        String
  userId          String   @unique
  email           String?
  name            String?
  company         String
  billingAddress  Json     @default("{}")
  shippingAddress Json     @default("{}")
  taxId           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
}

// ==================== QUOTING MODELS ====================

model Quote {
  id             String    @id @default(cuid())
  tenantId       String
  customerId     String?
  number         String    @unique
  status         String    @default("draft")
  currency       Currency  @default(MXN)
  exchangeRate   Decimal?  @db.Decimal(12, 6) // Rate used at quote creation
  baseCurrency   Currency? // Original pricing currency
  objective      Json      @default("{\"cost\": 0.5, \"lead\": 0.3, \"green\": 0.2}")
  validityUntil  DateTime
  validUntil     DateTime?
  subtotal       Decimal?  @db.Decimal(10, 2)
  tax            Decimal?  @db.Decimal(10, 2)
  shipping       Decimal   @default(0) @db.Decimal(10, 2)
  total          Decimal?  @db.Decimal(10, 2)
  totalPrice     Decimal?  @db.Decimal(10, 2)
  totals         Json?
  sustainability Json?
  metadata       Json      @default("{}")
  origin         String    @default("authenticated")
  guestSessionId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  tenant         Tenant            @relation(fields: [tenantId], references: [id])
  customer       User?             @relation(fields: [customerId], references: [id])
  guestSession   GuestSession?     @relation(fields: [guestSessionId], references: [id])
  items          QuoteItem[]
  paymentIntents PaymentIntent[]
  auditLogs      AuditLog[]
  orders         Order[]
  conversions    QuoteConversion[]

  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

model QuoteItem {
  id             String   @id @default(cuid())
  quoteId        String
  fileId         String?
  partId         String?
  name           String
  process        String
  processCode    String
  material       String
  materialId     String?
  processId      String?
  quantity       Int
  unitPrice      Decimal? @db.Decimal(10, 2)
  totalPrice     Decimal? @db.Decimal(10, 2)
  leadTime       Int?
  leadDays       Int?
  selections     Json
  costBreakdown  Json?
  sustainability Json?
  flags          String[] @default([])
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  quote               Quote                  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  files               File[]
  part                File?                  @relation("QuoteItemPart", fields: [partId], references: [id])
  materialObj         Material?              @relation(fields: [materialId], references: [id])
  manufacturingProcess ManufacturingProcess?  @relation(fields: [processId], references: [id])
  dfmReport           DFMReport?
  supplierBids        SupplierBid[]
  orderItems          OrderItem[]

  @@index([quoteId])
  @@index([fileId])
  @@index([processCode])
}

model File {
  id              String   @id @default(cuid())
  tenantId        String
  quoteItemId     String?
  filename        String
  originalName    String
  type            String
  size            Int
  path            String
  s3Key           String?
  hash            String
  version         Int      @default(1)
  ndaAcceptanceId String?
  metadata        Json     @default("{}")
  status          String   @default("PENDING")
  analysisResult  Json?
  analyzedAt      DateTime?
  at              DateTime @default(now()) // For compliance date-based queries
  createdAt       DateTime @default(now())

  // Relations
  quoteItems     QuoteItem[]
  quoteItemParts QuoteItem[]    @relation("QuoteItemPart")
  orderItems     OrderItem[]
  ndaAcceptance  NDAAcceptance? @relation(fields: [ndaAcceptanceId], references: [id])
  fileAnalysis   FileAnalysis?

  @@index([tenantId])
  @@index([quoteItemId])
  @@index([hash])
  @@index([status])
  @@index([at])
}

model DFMReport {
  id          String   @id @default(cuid())
  quoteItemId String   @unique
  metrics     Json
  issues      Json     @default("[]")
  riskScore   Int
  createdAt   DateTime @default(now())

  // Relations
  quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
}

// ==================== PRICING & CATALOG MODELS ====================

model Material {
  id                   String    @id @default(cuid())
  tenantId             String
  process              String
  name                 String
  code                 String
  density              Decimal   @db.Decimal(6, 3)
  co2eFactor           Decimal   @db.Decimal(6, 3)
  costUom              String    @default("kg")
  pricePerUom          Decimal   @db.Decimal(10, 2)
  costPerUnit          Decimal   @db.Decimal(10, 2)
  costPerKg            Decimal?  @db.Decimal(10, 2)
  recycledPercent      Decimal?  @db.Decimal(5, 2)
  properties           Json      @default("{}")
  active               Boolean   @default(true)
  versionEffectiveFrom DateTime  @default(now())
  versionEffectiveTo   DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  quoteItems QuoteItem[]

  @@unique([tenantId, code, versionEffectiveFrom])
  @@index([tenantId])
  @@index([process])
  @@index([active])
}

model ManufacturingProcess {
  id           String   @id @default(cuid())
  tenantId     String
  code         String
  name         String
  category     String
  setupCost    Decimal? @db.Decimal(10, 2)
  hourlyRate   Decimal? @db.Decimal(10, 2)
  minOrderQty  Int?
  maxPartSize  Json?
  capabilities Json     @default("{}")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  quoteItems QuoteItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([category])
  @@index([active])
}

model Machine {
  id           String   @id @default(cuid())
  tenantId     String
  process      String
  model        String
  name         String
  powerW       Int
  hourlyRate   Decimal  @db.Decimal(10, 2)
  setupMinutes Int
  specs        Json
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([process])
  @@index([active])
}

model ProcessOption {
  id                 String   @id @default(cuid())
  tenantId           String
  process            String
  optionsSchema      Json
  marginFloorPercent Decimal  @db.Decimal(5, 2)
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, process])
  @@index([process])
}

model PricingRule {
  id         String   @id @default(cuid())
  tenantId   String
  name       String
  process    String
  formula    String
  parameters Json
  conditions Json     @default("[]")
  priority   Int      @default(0)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([process])
  @@index([active])
  @@index([priority])
}

model Margin {
  id                 String   @id @default(cuid())
  tenantId           String
  type               String   @default("default")
  process            String?
  marginPercent      Decimal  @db.Decimal(5, 2)
  floorPercent       Decimal  @db.Decimal(5, 2)
  targetPercent      Decimal  @db.Decimal(5, 2)
  maxDiscountPercent Decimal  @db.Decimal(5, 2)
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, type, process])
  @@index([tenantId])
  @@index([active])
}

model DiscountRule {
  id         String   @id @default(cuid())
  tenantId   String
  name       String
  scope      String // quote, item, customer
  formula    String
  thresholds Json
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([scope])
  @@index([active])
}

model ShippingRate {
  id           String   @id @default(cuid())
  tenantId     String
  carrier      String
  serviceCode  String
  serviceName  String
  leadDays     Int
  priceFormula String
  zones        Json     @default("[]")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([carrier])
  @@index([active])
}

// ==================== SUPPLIER MODELS (P1) ====================

model SupplierBid {
  id          String   @id @default(cuid())
  tenantId    String
  quoteItemId String
  supplierId  String
  price       Decimal  @db.Decimal(10, 2)
  leadDays    Int
  co2e        Decimal  @db.Decimal(6, 3)
  selected    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id])

  @@index([quoteItemId])
  @@index([supplierId])
}

// ==================== PAYMENT MODELS ====================

model PaymentIntent {
  id                    String    @id @default(cuid())
  tenantId              String
  quoteId               String
  orderId               String?
  provider              String    @default("stripe")
  amount                Decimal   @db.Decimal(10, 2)
  currency              String
  status                String
  externalRef           String?
  stripePaymentIntentId String?   @unique
  stripeSessionId       String?   @unique
  paidAt                DateTime?
  errorMessage          String?
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  quote  Quote  @relation(fields: [quoteId], references: [id])
  order  Order? @relation(fields: [orderId], references: [id])

  @@index([tenantId])
  @@index([quoteId])
  @@index([orderId])
  @@index([externalRef])
  @@index([stripePaymentIntentId])
  @@index([stripeSessionId])
}

// ==================== COMPLIANCE & AUDIT MODELS ====================

model AuditLog {
  id       String   @id @default(cuid())
  tenantId String
  actorId  String?
  entity   String
  entityId String
  action   String
  before   Json?
  after    Json?
  metadata Json     @default("{}")
  at       DateTime @default(now())

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  actor   User?   @relation(fields: [actorId], references: [id])
  Quote   Quote?  @relation(fields: [quoteId], references: [id])
  quoteId String?

  @@index([tenantId])
  @@index([entity, entityId])
  @@index([actorId])
  @@index([at])
}

model NDAAcceptance {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  email     String
  ip        String
  userAgent String
  version   String
  at        DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])
  files  File[]

  @@index([tenantId])
  @@index([email])
  @@index([at])
}

// ==================== SYSTEM MODELS ====================

model FXRate {
  id       String   @id @default(cuid())
  base     String
  quote    String
  rate     Decimal  @db.Decimal(10, 6)
  asOf     DateTime
  source   String   @default("openexchangerates")
  tenantId String?

  @@unique([base, quote, asOf])
  @@index([asOf])
}

// ==================== API KEY MODELS ====================

model ApiKey {
  id         String    @id @default(cuid())
  tenantId   String
  name       String
  keyHash    String
  keyPrefix  String    // First 8 chars for identification
  scopes     Json      @default("[]")
  rateLimit  Int?      // Requests per hour
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  revokedAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  tenant Tenant        @relation(fields: [tenantId], references: [id])
  usage  ApiKeyUsage[]

  @@index([tenantId])
  @@index([keyPrefix])
  @@index([isActive])
}

// ==================== GUEST QUOTE MODELS ====================

model GuestSession {
  id              String    @id @default(cuid())
  sessionToken    String    @unique
  ipAddress       String?
  userAgent       String?
  referrer        String?
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  quoteCount      Int       @default(0)
  convertedAt     DateTime?
  convertedUserId String?

  // Relations
  convertedUser   User?             @relation(fields: [convertedUserId], references: [id])
  guestQuotes     GuestQuote[]
  conversions     QuoteConversion[]
  quotes          Quote[]

  @@index([expiresAt])
  @@index([convertedUserId])
}

model GuestQuote {
  id          String   @id @default(cuid())
  sessionId   String
  quoteData   Json
  fileKeys    String[]
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  accessedAt  DateTime @default(now())
  accessCount Int      @default(1)

  // Relations
  session     GuestSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  conversions QuoteConversion[]

  @@index([sessionId])
  @@index([createdAt])
  @@index([status])
}

model QuoteConversion {
  id               String   @id @default(cuid())
  guestQuoteId     String
  convertedQuoteId String
  userId           String
  sessionId        String
  conversionType   String
  createdAt        DateTime @default(now())

  // Relations
  guestQuote     GuestQuote   @relation(fields: [guestQuoteId], references: [id])
  convertedQuote Quote        @relation(fields: [convertedQuoteId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
  session        GuestSession @relation(fields: [sessionId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([guestQuoteId])
  @@index([convertedQuoteId])
}

model ApiKeyUsage {
  id        String   @id @default(cuid())
  apiKeyId  String
  ipAddress String
  endpoint  String
  timestamp DateTime @default(now())

  // Relations
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id])

  @@index([apiKeyId])
  @@index([timestamp])
}

// ==================== JOB QUEUE MODELS ====================

model FileAnalysis {
  id               String   @id @default(cuid())
  fileId           String   @unique
  tenantId         String
  volume           Decimal? @db.Decimal(10, 3)
  surfaceArea      Decimal? @db.Decimal(10, 3)
  boundingBoxX     Decimal? @db.Decimal(10, 3)
  boundingBoxY     Decimal? @db.Decimal(10, 3)
  boundingBoxZ     Decimal? @db.Decimal(10, 3)
  partCount        Int      @default(1)
  triangleCount    Int?
  dfmScore         Int      @default(100)
  dfmIssues        Json     @default("[]")
  manufacturable   Boolean  @default(true)
  hasUndercuts     Boolean  @default(false)
  hasThinWalls     Boolean  @default(false)
  hasSmallFeatures Boolean  @default(false)
  complexity       String   @default("simple")
  processingTime   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  file File @relation(fields: [fileId], references: [id])

  @@index([tenantId])
  @@index([fileId])
}

model Report {
  id          String   @id @default(cuid())
  tenantId    String
  type        String
  entityId    String
  fileName    String
  fileUrl     String
  fileSize    Int
  status      String   @default("PENDING")
  generatedAt DateTime?
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@index([entityId])
  @@index([status])
}

model Order {
  id                  String    @id @default(cuid())
  tenantId            String
  orderNumber         String    @unique
  quoteId             String
  customerId          String
  status              String    @default("PENDING")
  paymentStatus       String    @default("PENDING")
  subtotal            Decimal   @db.Decimal(10, 2)
  tax                 Decimal   @db.Decimal(10, 2)
  shipping            Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount         Decimal   @db.Decimal(10, 2)
  totalPaid           Decimal   @default(0) @db.Decimal(10, 2)
  currency            String
  productionStartedAt DateTime?
  completedAt         DateTime?
  shippedAt           DateTime?
  metadata            Json      @default("{}")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  quote          Quote           @relation(fields: [quoteId], references: [id])
  customer       User            @relation(fields: [customerId], references: [id])
  orderItems     OrderItem[]
  invoices       Invoice[]
  paymentIntents PaymentIntent[]

  @@index([tenantId])
  @@index([quoteId])
  @@index([customerId])
  @@index([status])
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  partId        String
  quoteItemId   String?
  tenantId      String
  quantity      Int
  process       String
  material      String
  finishOptions Json     @default("{}")
  unitPrice     Decimal  @db.Decimal(10, 2)
  subtotal      Decimal  @db.Decimal(10, 2)
  leadTimeDays  Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  part      File       @relation(fields: [partId], references: [id])
  quoteItem QuoteItem? @relation(fields: [quoteItemId], references: [id])

  @@index([orderId])
  @@index([tenantId])
}

model Invoice {
  id               String    @id @default(cuid())
  tenantId         String
  number           String?   @unique
  orderId          String?
  customerId       String?
  period           String    // For billing invoices (YYYY-MM)
  baseFee          Decimal?  @db.Decimal(10, 2)
  usageCost        Decimal?  @db.Decimal(10, 2)
  currency         String    @default("USD")
  totalAmount      Decimal   @db.Decimal(10, 2) @map("total")
  status           String    @default("pending") // pending, paid, overdue, failed
  dueDate          DateTime
  paidAt           DateTime?
  stripeInvoiceId  String?   @unique
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  order    Order? @relation(fields: [orderId], references: [id])
  customer User?  @relation(fields: [customerId], references: [id])

  @@index([tenantId])
  @@index([orderId])
  @@index([customerId])
  @@index([period])
  @@index([status])
  @@index([dueDate])
}

// ==================== BILLING MODELS ====================

model BillingPlan {
  id              String   @id @default(cuid())
  name            String   @unique
  description     String?
  monthlyPrice    Decimal  @db.Decimal(10, 2)
  yearlyPrice     Decimal  @db.Decimal(10, 2)
  includedQuotas  Json     // Record<UsageEventType, number>
  overageRates    Json     // Record<UsageEventType, number>
  features        Json     // string[]
  maxTeamMembers  Int      @default(1)
  apiRateLimit    Int      @default(100)
  supportLevel    String   @default("community") // community, email, priority, white-glove
  customBranding  Boolean  @default(false)
  whiteLabel      Boolean  @default(false)
  sla             String?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenants Tenant[]

  @@index([name])
  @@index([active])
}

model UsageEvent {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  eventType String   // UsageEventType enum
  quantity  Int      @default(1)
  metadata  Json     @default("{}")
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId, eventType, timestamp])
  @@index([tenantId, timestamp])
  @@index([eventType])
  @@map("usage_events")
}

// ==================== ENTERPRISE MODELS ====================

model SSOProvider {
  id            String   @id @default(cuid())
  tenantId      String
  name          String
  type          String   // SSOProviderType enum
  enabled       Boolean  @default(true)
  configuration Json     // SSOConfiguration
  metadata      Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@index([enabled])
  @@map("sso_providers")
}

model WhiteLabelConfiguration {
  id            String   @id @default(cuid())
  tenantId      String   @unique
  branding      Json     // BrandingConfiguration
  customization Json     // CustomizationConfiguration
  domain        Json     // DomainConfiguration
  features      Json     // FeatureConfiguration
  deployment    Json     // DeploymentConfiguration
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId])
  @@map("white_label_configurations")
}

model DataRetentionPolicy {
  id                        String    @id @default(cuid())
  tenantId                  String    @unique
  auditLogRetentionDays     Int       @default(365)
  fileRetentionDays         Int       @default(730)
  inactiveUserRetentionDays Int       @default(90)
  autoDeleteEnabled         Boolean   @default(false)
  lastEnforcedAt            DateTime?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  @@index([tenantId])
  @@map("data_retention_policies")
}

model SupportTicket {
  id             String    @id @default(cuid())
  tenantId       String
  userId         String?
  subject        String
  description    String
  priority       String    // TicketPriority enum
  status         String    @default("open") // TicketStatus enum
  category       String
  assignedToId   String?
  tags           String[]  @default([])
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  resolvedAt     DateTime?
  firstResponseAt DateTime?
  escalatedAt    DateTime?

  // Relations
  user       User?                   @relation(fields: [userId], references: [id])
  assignedTo User?                   @relation("AssignedTickets", fields: [assignedToId], references: [id])
  messages   SupportTicketMessage[]

  @@index([tenantId])
  @@index([userId])
  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([category])
  @@index([createdAt])
  @@map("support_tickets")
}

model SupportTicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  userId      String
  content     String
  isInternal  Boolean  @default(false)
  attachments String[] @default([])
  createdAt   DateTime @default(now())

  // Relations
  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
  @@index([createdAt])
  @@map("support_ticket_messages")
}

// ==================== LOCALIZATION MODELS ====================

model Translation {
  id        String   @id @default(cuid())
  key       String   // e.g., "errors.validation.required"
  locale    String   // e.g., "es", "en", "pt-BR"
  value     String   // The translated text
  namespace String   @default("common") // Group translations
  metadata  Json     @default("{}") // Additional context
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, locale])
  @@index([locale])
  @@index([namespace])
  @@index([key])
  @@map("translations")
}

// ==================== MULTICURRENCY & GEO MODELS ====================

model ExchangeRate {
  id             String   @id @default(cuid())
  baseCurrency   Currency
  targetCurrency Currency
  rate           Decimal  @db.Decimal(12, 6)
  source         String   // 'openexchangerates', 'xe', 'manual'
  validFrom      DateTime
  validUntil     DateTime
  createdAt      DateTime @default(now())

  @@unique([baseCurrency, targetCurrency, validFrom])
  @@index([baseCurrency, targetCurrency])
  @@index([validFrom, validUntil])
  @@index([source])
  @@map("exchange_rates")
}

model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  preferredLocale   String   @default("es")
  preferredCurrency Currency @default(MXN)
  timezone          String?
  autoDetect        Boolean  @default(true)
  currencyDisplayMode String @default("symbol") // 'symbol', 'code', 'name'
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([preferredCurrency])
  @@index([preferredLocale])
  @@map("user_preferences")
}

model GeoSession {
  id               String    @id @default(cuid())
  sessionId        String    @unique
  ipAddress        String
  country          String?
  countryCode      String?
  city             String?
  region           String?
  timezone         String?
  detectedLocale   String?
  detectedCurrency Currency?
  selectedLocale   String?
  selectedCurrency Currency?
  confidence       Int?      // Detection confidence score 0-100
  source           String?   // 'edge-header', 'ip-service', 'browser', 'default'
  userAgent        String?
  metadata         Json      @default("{}")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([sessionId])
  @@index([ipAddress])
  @@index([countryCode])
  @@index([detectedCurrency])
  @@index([createdAt])
  @@map("geo_sessions")
}
