generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CORE MODELS ====================

model Tenant {
  id                  String   @id @default(cuid())
  name                String
  code                String   @unique
  domain              String?  @unique
  defaultCurrency     String   @default("MXN")
  supportedCurrencies String[] @default(["MXN", "USD"])
  defaultLocale       String   @default("es")
  supportedLocales    String[] @default(["es", "en"])
  features            Json     @default("{}")
  settings            Json     @default("{}")
  branding            Json     @default("{}")
  active              Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  users          User[]
  materials      Material[]
  machines       Machine[]
  processOptions ProcessOption[]
  quotes         Quote[]
  auditLogs      AuditLog[]
  ndaAcceptances NDAAcceptance[]
  discountRules  DiscountRule[]
  shippingRates  ShippingRate[]
  pricingRules   PricingRule[]
  margins        Margin[]
  customers      Customer[]
  apiKeys        ApiKey[]

  @@index([code])
  @@index([domain])
}

model User {
  id            String    @id @default(cuid())
  tenantId      String
  email         String    @unique
  passwordHash  String?
  firstName     String?
  lastName      String?
  name          String?
  phone         String?
  role          String    @default("customer")
  roles         String[]  @default(["customer"])
  active        Boolean   @default(true)
  emailVerified Boolean   @default(false)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant               Tenant            @relation(fields: [tenantId], references: [id])
  quotes               Quote[]
  auditLogs            AuditLog[]
  ndaAcceptances       NDAAcceptance[]
  sessions             Session[]
  customer             Customer?
  orders               Order[]
  invoices             Invoice[]
  convertedSessions    GuestSession[]
  quoteConversions     QuoteConversion[]

  @@index([tenantId])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Customer {
  id              String   @id @default(cuid())
  tenantId        String
  userId          String   @unique
  email           String?
  name            String?
  company         String
  billingAddress  Json     @default("{}")
  shippingAddress Json     @default("{}")
  taxId           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
}

// ==================== QUOTING MODELS ====================

model Quote {
  id             String    @id @default(cuid())
  tenantId       String
  customerId     String?
  number         String    @unique
  status         String    @default("draft")
  currency       String    @default("MXN")
  objective      Json      @default("{\"cost\": 0.5, \"lead\": 0.3, \"green\": 0.2}")
  validityUntil  DateTime
  validUntil     DateTime?
  subtotal       Decimal?  @db.Decimal(10, 2)
  tax            Decimal?  @db.Decimal(10, 2)
  shipping       Decimal   @default(0) @db.Decimal(10, 2)
  total          Decimal?  @db.Decimal(10, 2)
  totalPrice     Decimal?  @db.Decimal(10, 2)
  totals         Json?
  sustainability Json?
  metadata       Json      @default("{}")
  origin         String    @default("authenticated")
  guestSessionId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  tenant         Tenant            @relation(fields: [tenantId], references: [id])
  customer       User?             @relation(fields: [customerId], references: [id])
  guestSession   GuestSession?     @relation(fields: [guestSessionId], references: [id])
  items          QuoteItem[]
  paymentIntents PaymentIntent[]
  auditLogs      AuditLog[]
  orders         Order[]
  conversions    QuoteConversion[]

  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([createdAt])
}

model QuoteItem {
  id             String   @id @default(cuid())
  quoteId        String
  fileId         String?
  partId         String?
  name           String
  process        String
  processCode    String
  material       String
  materialId     String?
  processId      String?
  quantity       Int
  unitPrice      Decimal? @db.Decimal(10, 2)
  totalPrice     Decimal? @db.Decimal(10, 2)
  leadTime       Int?
  leadDays       Int?
  selections     Json
  costBreakdown  Json?
  sustainability Json?
  flags          String[] @default([])
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  quote               Quote                  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  files               File[]
  part                File?                  @relation("QuoteItemPart", fields: [partId], references: [id])
  materialObj         Material?              @relation(fields: [materialId], references: [id])
  manufacturingProcess ManufacturingProcess?  @relation(fields: [processId], references: [id])
  dfmReport           DFMReport?
  supplierBids        SupplierBid[]
  orderItems          OrderItem[]

  @@index([quoteId])
  @@index([fileId])
  @@index([processCode])
}

model File {
  id              String   @id @default(cuid())
  tenantId        String
  quoteItemId     String?
  filename        String
  originalName    String
  type            String
  size            Int
  path            String
  hash            String
  version         Int      @default(1)
  ndaAcceptanceId String?
  metadata        Json     @default("{}")
  status          String   @default("PENDING")
  analysisResult  Json?
  analyzedAt      DateTime?
  createdAt       DateTime @default(now())

  // Relations
  quoteItems     QuoteItem[]
  quoteItemParts QuoteItem[]    @relation("QuoteItemPart")
  orderItems     OrderItem[]
  ndaAcceptance  NDAAcceptance? @relation(fields: [ndaAcceptanceId], references: [id])
  fileAnalysis   FileAnalysis?

  @@index([tenantId])
  @@index([quoteItemId])
  @@index([hash])
  @@index([status])
}

model DFMReport {
  id          String   @id @default(cuid())
  quoteItemId String   @unique
  metrics     Json
  issues      Json     @default("[]")
  riskScore   Int
  createdAt   DateTime @default(now())

  // Relations
  quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id], onDelete: Cascade)
}

// ==================== PRICING & CATALOG MODELS ====================

model Material {
  id                   String    @id @default(cuid())
  tenantId             String
  process              String
  name                 String
  code                 String
  density              Decimal   @db.Decimal(6, 3)
  co2eFactor           Decimal   @db.Decimal(6, 3)
  costUom              String    @default("kg")
  pricePerUom          Decimal   @db.Decimal(10, 2)
  costPerUnit          Decimal   @db.Decimal(10, 2)
  costPerKg            Decimal?  @db.Decimal(10, 2)
  recycledPercent      Decimal?  @db.Decimal(5, 2)
  properties           Json      @default("{}")
  active               Boolean   @default(true)
  versionEffectiveFrom DateTime  @default(now())
  versionEffectiveTo   DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  quoteItems QuoteItem[]

  @@unique([tenantId, code, versionEffectiveFrom])
  @@index([tenantId])
  @@index([process])
  @@index([active])
}

model ManufacturingProcess {
  id           String   @id @default(cuid())
  tenantId     String
  code         String
  name         String
  category     String
  setupCost    Decimal? @db.Decimal(10, 2)
  hourlyRate   Decimal? @db.Decimal(10, 2)
  minOrderQty  Int?
  maxPartSize  Json?
  capabilities Json     @default("{}")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  quoteItems QuoteItem[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([category])
  @@index([active])
}

model Machine {
  id           String   @id @default(cuid())
  tenantId     String
  process      String
  model        String
  name         String
  powerW       Int
  hourlyRate   Decimal  @db.Decimal(10, 2)
  setupMinutes Int
  specs        Json
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([process])
  @@index([active])
}

model ProcessOption {
  id                 String   @id @default(cuid())
  tenantId           String
  process            String
  optionsSchema      Json
  marginFloorPercent Decimal  @db.Decimal(5, 2)
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, process])
  @@index([process])
}

model PricingRule {
  id         String   @id @default(cuid())
  tenantId   String
  name       String
  process    String
  formula    String
  parameters Json
  conditions Json     @default("[]")
  priority   Int      @default(0)
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([process])
  @@index([active])
  @@index([priority])
}

model Margin {
  id                 String   @id @default(cuid())
  tenantId           String
  type               String   @default("default")
  process            String?
  marginPercent      Decimal  @db.Decimal(5, 2)
  floorPercent       Decimal  @db.Decimal(5, 2)
  targetPercent      Decimal  @db.Decimal(5, 2)
  maxDiscountPercent Decimal  @db.Decimal(5, 2)
  active             Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, type, process])
  @@index([tenantId])
  @@index([active])
}

model DiscountRule {
  id         String   @id @default(cuid())
  tenantId   String
  name       String
  scope      String // quote, item, customer
  formula    String
  thresholds Json
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([scope])
  @@index([active])
}

model ShippingRate {
  id           String   @id @default(cuid())
  tenantId     String
  carrier      String
  serviceCode  String
  serviceName  String
  leadDays     Int
  priceFormula String
  zones        Json     @default("[]")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([carrier])
  @@index([active])
}

// ==================== SUPPLIER MODELS (P1) ====================

model SupplierBid {
  id          String   @id @default(cuid())
  tenantId    String
  quoteItemId String
  supplierId  String
  price       Decimal  @db.Decimal(10, 2)
  leadDays    Int
  co2e        Decimal  @db.Decimal(6, 3)
  selected    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  quoteItem QuoteItem @relation(fields: [quoteItemId], references: [id])

  @@index([quoteItemId])
  @@index([supplierId])
}

// ==================== PAYMENT MODELS ====================

model PaymentIntent {
  id                    String    @id @default(cuid())
  tenantId              String
  quoteId               String
  orderId               String?
  provider              String    @default("stripe")
  amount                Decimal   @db.Decimal(10, 2)
  currency              String
  status                String
  externalRef           String?
  stripePaymentIntentId String?   @unique
  stripeSessionId       String?   @unique
  paidAt                DateTime?
  errorMessage          String?
  metadata              Json      @default("{}")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  quote  Quote  @relation(fields: [quoteId], references: [id])
  order  Order? @relation(fields: [orderId], references: [id])

  @@index([tenantId])
  @@index([quoteId])
  @@index([orderId])
  @@index([externalRef])
  @@index([stripePaymentIntentId])
  @@index([stripeSessionId])
}

// ==================== COMPLIANCE & AUDIT MODELS ====================

model AuditLog {
  id       String   @id @default(cuid())
  tenantId String
  actorId  String?
  entity   String
  entityId String
  action   String
  before   Json?
  after    Json?
  metadata Json     @default("{}")
  at       DateTime @default(now())

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  actor   User?   @relation(fields: [actorId], references: [id])
  Quote   Quote?  @relation(fields: [quoteId], references: [id])
  quoteId String?

  @@index([tenantId])
  @@index([entity, entityId])
  @@index([actorId])
  @@index([at])
}

model NDAAcceptance {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?
  email     String
  ip        String
  userAgent String
  version   String
  at        DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])
  files  File[]

  @@index([tenantId])
  @@index([email])
  @@index([at])
}

// ==================== SYSTEM MODELS ====================

model FXRate {
  id       String   @id @default(cuid())
  base     String
  quote    String
  rate     Decimal  @db.Decimal(10, 6)
  asOf     DateTime
  source   String   @default("openexchangerates")
  tenantId String?

  @@unique([base, quote, asOf])
  @@index([asOf])
}

// ==================== API KEY MODELS ====================

model ApiKey {
  id         String    @id @default(cuid())
  tenantId   String
  name       String
  keyHash    String
  keyPrefix  String    // First 8 chars for identification
  scopes     Json      @default("[]")
  rateLimit  Int?      // Requests per hour
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  revokedAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  tenant Tenant        @relation(fields: [tenantId], references: [id])
  usage  ApiKeyUsage[]

  @@index([tenantId])
  @@index([keyPrefix])
  @@index([isActive])
}

// ==================== GUEST QUOTE MODELS ====================

model GuestSession {
  id              String    @id @default(cuid())
  sessionToken    String    @unique
  ipAddress       String?
  userAgent       String?
  referrer        String?
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  quoteCount      Int       @default(0)
  convertedAt     DateTime?
  convertedUserId String?

  // Relations
  convertedUser   User?             @relation(fields: [convertedUserId], references: [id])
  guestQuotes     GuestQuote[]
  conversions     QuoteConversion[]
  quotes          Quote[]

  @@index([expiresAt])
  @@index([convertedUserId])
}

model GuestQuote {
  id          String   @id @default(cuid())
  sessionId   String
  quoteData   Json
  fileKeys    String[]
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  accessedAt  DateTime @default(now())
  accessCount Int      @default(1)

  // Relations
  session     GuestSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  conversions QuoteConversion[]

  @@index([sessionId])
  @@index([createdAt])
  @@index([status])
}

model QuoteConversion {
  id               String   @id @default(cuid())
  guestQuoteId     String
  convertedQuoteId String
  userId           String
  sessionId        String
  conversionType   String
  createdAt        DateTime @default(now())

  // Relations
  guestQuote     GuestQuote   @relation(fields: [guestQuoteId], references: [id])
  convertedQuote Quote        @relation(fields: [convertedQuoteId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
  session        GuestSession @relation(fields: [sessionId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([guestQuoteId])
  @@index([convertedQuoteId])
}

model ApiKeyUsage {
  id        String   @id @default(cuid())
  apiKeyId  String
  ipAddress String
  endpoint  String
  timestamp DateTime @default(now())

  // Relations
  apiKey ApiKey @relation(fields: [apiKeyId], references: [id])

  @@index([apiKeyId])
  @@index([timestamp])
}

// ==================== JOB QUEUE MODELS ====================

model FileAnalysis {
  id               String   @id @default(cuid())
  fileId           String   @unique
  tenantId         String
  volume           Decimal? @db.Decimal(10, 3)
  surfaceArea      Decimal? @db.Decimal(10, 3)
  boundingBoxX     Decimal? @db.Decimal(10, 3)
  boundingBoxY     Decimal? @db.Decimal(10, 3)
  boundingBoxZ     Decimal? @db.Decimal(10, 3)
  partCount        Int      @default(1)
  triangleCount    Int?
  dfmScore         Int      @default(100)
  dfmIssues        Json     @default("[]")
  manufacturable   Boolean  @default(true)
  hasUndercuts     Boolean  @default(false)
  hasThinWalls     Boolean  @default(false)
  hasSmallFeatures Boolean  @default(false)
  complexity       String   @default("simple")
  processingTime   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  file File @relation(fields: [fileId], references: [id])

  @@index([tenantId])
  @@index([fileId])
}

model Report {
  id          String   @id @default(cuid())
  tenantId    String
  type        String
  entityId    String
  fileName    String
  fileUrl     String
  fileSize    Int
  status      String   @default("PENDING")
  generatedAt DateTime?
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@index([entityId])
  @@index([status])
}

model Order {
  id                  String    @id @default(cuid())
  tenantId            String
  orderNumber         String    @unique
  quoteId             String
  customerId          String
  status              String    @default("PENDING")
  paymentStatus       String    @default("PENDING")
  subtotal            Decimal   @db.Decimal(10, 2)
  tax                 Decimal   @db.Decimal(10, 2)
  shipping            Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount         Decimal   @db.Decimal(10, 2)
  totalPaid           Decimal   @default(0) @db.Decimal(10, 2)
  currency            String
  productionStartedAt DateTime?
  completedAt         DateTime?
  shippedAt           DateTime?
  metadata            Json      @default("{}")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  quote          Quote           @relation(fields: [quoteId], references: [id])
  customer       User            @relation(fields: [customerId], references: [id])
  orderItems     OrderItem[]
  invoices       Invoice[]
  paymentIntents PaymentIntent[]

  @@index([tenantId])
  @@index([quoteId])
  @@index([customerId])
  @@index([status])
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  partId        String
  quoteItemId   String?
  tenantId      String
  quantity      Int
  process       String
  material      String
  finishOptions Json     @default("{}")
  unitPrice     Decimal  @db.Decimal(10, 2)
  subtotal      Decimal  @db.Decimal(10, 2)
  leadTimeDays  Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  order     Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  part      File       @relation(fields: [partId], references: [id])
  quoteItem QuoteItem? @relation(fields: [quoteItemId], references: [id])

  @@index([orderId])
  @@index([tenantId])
}

model Invoice {
  id         String   @id @default(cuid())
  tenantId   String
  number     String   @unique
  orderId    String
  customerId String
  currency   String
  total      Decimal  @db.Decimal(10, 2)
  dueDate    DateTime
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  order    Order @relation(fields: [orderId], references: [id])
  customer User  @relation(fields: [customerId], references: [id])

  @@index([tenantId])
  @@index([orderId])
  @@index([customerId])
}
